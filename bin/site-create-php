#!/bin/bash

# Make sure warpspeed environment vars are available before proceeding.
if [ -z "$WARPSPEED_ROOT" ] || [ -z "$WARPSPEED_USER" ]; then
    echo "Error: It appears that this server was not provisioned with Warpspeed."
    echo "WARPSPEED_ROOT and WARPSPEED_USER env vars were not found."
    exit 1
fi

# Import the warpspeed functions.
source $WARPSPEED_ROOT/includes/functions.sh

if [ -z "$SITE_NAME" ]; then
    echo "Usage: $0 sitename [OPTIONS]..."
    exit 1
fi

SITE_NAME=$1
FORCE=0
PUSHREPO=0

for arg in "$@"; do
case $arg in
    --force)
        FORCE=1
    ;;
    --push)
        PUSHREPO=1
    ;;
esac; done

# Make sure the site doesn't already exist.
if [ -d "/home/$WARPSPEED_USER/sites/$SITE_NAME" ] && [ $FORCE -ne 1 ]; then
    echo "Error: The site /home/$WARPSPEED_USER/sites/$SITE_NAME already exists. Use '$0 $SITE_NAME --force' to override."
    exit 1
fi

echo "Creating site..."

# Create the site directory structure.
ws_create_site_structure $SITE_NAME

# Configure nginx to serve the new site.
ws_create_nginx_site $SITE_NAME

cp $WARPSPEED_ROOT/templates/php/index.php /home/$WARPSPEED_USER/sites/$SITE_NAME/public

# Setup a site specific php-fpm pool.
sudo cp $WARPSPEED_ROOT/templates/php/www.conf /etc/php5/fpm/pool.d/$SITE_NAME.conf
sudo sed -i "s/{{domain}}/$SITE_NAME/g" /etc/php5/fpm/pool.d/$SITE_NAME.conf
sudo sed -i "s/{{user}}/$WARPSPEED_USER/g" /etc/php5/fpm/pool.d/$SITE_NAME.conf

# Create site specific directories for uploads and sessions.
sudo mkdir -p /var/lib/php/$SITE_NAME/upload
sudo mkdir -p /var/lib/php/$SITE_NAME/session
sudo chown -R www-data:www-data /var/lib/php/$SITE_NAME

if [ $PUSHREPO -eq 1 ]; then
    ws_create_git_push_deploy_repo 
fi

# todo
# echo "env[LARAVEL_ENV] = local" | sudo tee -a /etc/php5/fpm/pool.d/$SITE_NAME.conf

# Restart services.
sudo service nginx reload
sudo service php5-fpm restart

echo "New site created at: /home/$WARPSPEED_USER/sites/$SITE_NAME"
echo "Setup DNS or modify your hosts file to allow site to be accessed via: $SITE_NAME."
