#!/bin/bash

# Make sure warpspeed environment vars are available before proceeding.
if [ -z "$WARPSPEED_ROOT" ] || [ -z "$WARPSPEED_USER" ]; then
    echo "Error: It appears that this server was not provisioned with Warpspeed."
    echo "WARPSPEED_ROOT and WARPSPEED_USER env vars were not found."
    exit 1
fi

# Import the warpspeed functions.
source $WARPSPEED_ROOT/includes/functions.sh

SITE_NAME=$1
APP_ENV="production"
FORCE=0
PUSHREPO=0

if [ -z "$SITE_NAME" ]; then
    echo "Usage: $0 sitename [OPTIONS]..."
    exit 1
fi

for arg in "$@"; do
case $arg in
    --env=*)
        APP_ENV="${arg#*=}"
    ;;
    --force)
        FORCE=1
    ;;
    --push)
        PUSHREPO=1
    ;;
esac; done

# Make sure the site doesn't already exist.
if [ -d "/home/$WARPSPEED_USER/sites/$SITE_NAME" ] && [ $FORCE -ne 1 ]; then
    echo "Error: The site /home/$WARPSPEED_USER/sites/$SITE_NAME already exists. Use '$0 $SITE_NAME --force' to override."
    exit 1
fi

echo "Creating site..."

# Create the site directory structure.
ws_create_site_structure $SITE_NAME public

# Copy the site template to the public directory.
cp -f $WARPSPEED_ROOT/templates/php/index.php /home/$WARPSPEED_USER/sites/$SITE_NAME/public

# Ensure that the ownership settings on the site folder are correct.
chown -R $WARPSPEED_USER:$WARPSPEED_USER /home/$WARPSPEED_USER/sites/$SITE_NAME

# Create site specific directories for uploads and sessions.
sudo mkdir -p /var/lib/php/$SITE_NAME/upload
sudo mkdir -p /var/lib/php/$SITE_NAME/session
sudo chown -R $WARPSPEED_USER:www-data /var/lib/php/$SITE_NAME

# Configure nginx to serve the new site.
ws_create_nginx_site $SITE_NAME site-php.conf

# Setup a site specific php-fpm configuration.
sudo cp -f $WARPSPEED_ROOT/templates/php/www.conf /etc/php5/fpm/pool.d/$SITE_NAME.conf
sudo sed -i "s/{{domain}}/$SITE_NAME/g" /etc/php5/fpm/pool.d/$SITE_NAME.conf
sudo sed -i "s/{{user}}/$WARPSPEED_USER/g" /etc/php5/fpm/pool.d/$SITE_NAME.conf

# Set APP_ENV environment variable in php fpm pool.
echo "env[APP_ENV] = $APP_ENV" | sudo tee -a /etc/php5/fpm/pool.d/$SITE_NAME.conf

# Create an init.d file for managing this php-fpm site.
sudo cp -f $WARPSPEED_ROOT/templates/php/php5-fpm-init.conf /etc/init/php5-fpm-$SITE_NAME.conf
sudo sed -i "s/{{domain}}/$SITE_NAME/g" /etc/init/php5-fpm-$SITE_NAME.conf
sudo initctl reload-configuration

if [ $PUSHREPO -eq 1 ]; then
    ws_create_git_push_deploy_repo 
fi

# Restart services.
sudo service nginx reload
sudo service php5-fpm-$SITE_NAME restart

echo "New site created at: /home/$WARPSPEED_USER/sites/$SITE_NAME"
echo "Setup DNS or modify your hosts file to allow site to be accessed via: $SITE_NAME."
