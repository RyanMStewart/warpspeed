#!/bin/bash

# Make sure warpspeed environment vars are available before proceeding.
if [ -z "$WARPSPEED_ROOT" ] || [ -z "$WARPSPEED_USER" ]; then
    echo "Error: It appears that this server was not provisioned with Warpspeed."
    echo "WARPSPEED_ROOT and WARPSPEED_USER env vars were not found."
    exit 1
fi

# Import the warpspeed functions.
source $WARPSPEED_ROOT/includes/functions.sh

# Place backup in sites directory.
# This is mainly because the sites directory is shared with the host in vagrant.
BACKUPDIR="/home/$WARPSPEED_USER/sites/db-backups"

# Create the db backup directory if it doesn't exist.
if [ ! -d $BACKUPDIR ]; then
    mkdir -p $BACKUPDIR
    echo "Created the db backup directory."
fi

echo "Please enter your mysql root database password when prompted."

if [ -z "$1" ]; then
    FILENAME="$BACKUPDIR/all_dbs_$(date +%Y-%m-%d_%H%M%S).sql.gz"
    mysqldump -u root -p --add-drop-table --all-databases | gzip -9 > $FILENAME
else
    FILENAME="$BACKUPDIR/$1_$(date +%Y-%m-%d_%H%M%S).sql.gz"
    mysqldump -u root -p --add-drop-table $1 | gzip -9 > $FILENAME
fi

if [ $? -eq 0 ]; then
    echo "Backup saved to: $FILENAME"
fi
