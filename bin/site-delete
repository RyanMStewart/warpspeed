#!/bin/bash

# Make sure warpspeed environment vars are available before proceeding.
if [ -z "$WARPSPEED_ROOT" ] || [ -z "$WARPSPEED_USER" ]; then
    echo "Error: It appears that this server was not provisioned with Warpspeed."
    echo "WARPSPEED_ROOT and WARPSPEED_USER env vars were not found."
    exit 1
fi

# Import the warpspeed functions.
source $WARPSPEED_ROOT/includes/functions.sh

if [ -z "$1" ]; then
    echo "Usage: $0 site.com"
    exit 1
fi

# Make sure the site exists
if [ ! -d "/home/$WARPSPEED_USER/sites/$1" ]; then
    echo "Error: The site /home/$WARPSPEED_USER/sites/$1 does not exist."
    exit 1
fi

SITE_NAME=$1

rm -rf /home/$WARPSPEED_USER/sites/$SITE_NAME
rm -rf /home/$WARPSPEED_USER/repos/$SITE_NAME.git

sudo rm -f /etc/nginx/sites-enabled/$SITE_NAME
sudo rm -f /etc/nginx/sites-available/$SITE_NAME

sudo rm -rf /var/lib/php/$SITE_NAME
sudo rm -f /var/log/php/$SITE_NAME-*.log
sudo rm -f /etc/php5/fpm/pool.d/$SITE_NAME.conf

# Reload nginx configs
sudo service nginx reload

# Check if we need to cleanup php upstart files and stop php fpm site.
if [ -f /etc/init/php5-fpm-$SITE_NAME.conf ]; then
    sudo service php5-fpm-$SITE_NAME stop
    sudo rm -f /etc/init/php5-fpm-$SITE_NAME.conf
    sudo initctl reload-configuration
fi

echo "All files for site $1 have been removed."
