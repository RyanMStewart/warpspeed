#!/bin/bash

# Make sure warpspeed environment vars are available before proceeding.
if [ -z "$WARPSPEED_ROOT" ] || [ -z "$WARPSPEED_USER" ]; then
    echo "Error: It appears that this server was not provisioned with Warpspeed."
    echo "WARPSPEED_ROOT and WARPSPEED_USER env vars were not found."
    exit 1
fi

# Import the warpspeed functions.
source $WARPSPEED_ROOT/includes/functions.sh

if [ -z "$1" ]; then
    echo "Usage: $0 hostname"
    exit 1
fi

# Make sure the site doesn't already exist.
if [ -d "/home/$USER/sites/$1" ]; then
    echo "Error: The site /home/$USER/sites/$1 already exists."
    exit 1
fi

echo "Creating site..."

# Create the site directory structure.
ws_create_site_structure $1

# Configure nginx to serve the new site.
ws_create_nginx_site $1 site-python.conf

cp $WARPSPEED_ROOT/templates/python/passenger_wsgi.py /home/$USER/sites/$1/passenger_wsgi.py

sudo service nginx reload

# todo, create virtualenv

# cd "/home/$USER/sites/$1"

# mkdir -p ~/venvs
# cd ~/venvs
# virtualenv $1-env
# ln -s ~/venvs/$1-env/bin/activate /home/$USER/sites/$1/activate

# cd /home/$USER/sites/$1
# source activate
# pip install django
# django-admin.py startproject app
